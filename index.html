<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Βελτιωμένη Προσομοίωση Αυτοκατάλυσης</title>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .input-group label {
      margin-bottom: 5px;
      font-weight: bold;
    }
    .input-group input {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .buttons {
      text-align: center;
      margin-top: 10px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #plot {
      width: 100%;
      height: 500px;
    }
    .tooltip {
      font-size: 0.9em;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Προσομοίωση Αυτοκατάλυσης με RK4</h1>
  <div class="container">
    <div class="input-group">
      <label for="A0" title="Αρχική συγκέντρωση του MnO₄⁻ (M)">A₀:</label>
      <input type="number" id="A0" value="0.1" step="0.01">
    </div>
    <div class="input-group">
      <label for="k" title="Σταθερά ταχύτητας (M⁻¹s⁻¹)">k:</label>
      <input type="number" id="k" value="0.2" step="0.01">
    </div>
    <div class="input-group">
      <label for="C0_red" title="Αρχική συγκέντρωση καταλύτη για την κόκκινη διαδικασία (M)">C₀ (Κόκκινη):</label>
      <input type="number" id="C0_red" value="0.001" step="0.001">
    </div>
    <div class="input-group">
      <label for="C0_green" title="Αρχική συγκέντρωση καταλύτη για την πράσινη διαδικασία (M)">C₀ (Πράσινη):</label>
      <input type="number" id="C0_green" value="0.1" step="0.01">
    </div>
    <div class="input-group">
      <label for="tMax" title="Μέγιστος χρόνος προσομοίωσης (s)">Μέγιστος Χρόνος:</label>
      <input type="number" id="tMax" value="500" step="100">
    </div>
    <div class="input-group">
      <label for="dt" title="Βήμα χρόνου (s)">Βήμα Χρόνου (dt):</label>
      <input type="number" id="dt" value="1" step="0.1">
    </div>
    <div class="buttons" style="grid-column: span 2;">
      <button onclick="updatePlot()">Ενημέρωση Προσομοίωσης</button>
      <button onclick="resetFields()">Επαναφορά</button>
    </div>
  </div>
  <div id="plot"></div>
  
  <script>
    // Αρχικές τιμές για επαναφορά
    const defaults = {
      A0: 0.1,
      k: 0.2,
      C0_red: 0.001,
      C0_green: 0.1,
      tMax: 500,
      dt: 1
    };

    // Συνάρτηση επαναφοράς τιμών εισόδου
    function resetFields() {
      document.getElementById('A0').value = defaults.A0;
      document.getElementById('k').value = defaults.k;
      document.getElementById('C0_red').value = defaults.C0_red;
      document.getElementById('C0_green').value = defaults.C0_green;
      document.getElementById('tMax').value = defaults.tMax;
      document.getElementById('dt').value = defaults.dt;
      updatePlot();
    }

    // Συνάρτηση υπολογισμού με τη μέθοδο Runge-Kutta 4ης τάξης για το σύστημα:
    // dA/dt = -k*A*B, dB/dt = k*A*B.
    function simulateRK4(A0, B0, k, tMax, dt) {
      let A = A0, B = B0;
      const tArr = [], AArr = [], rateArr = [];
      const steps = Math.floor(tMax/dt);
      
      for(let i=0; i<=steps; i++){
        let t = i*dt;
        tArr.push(t);
        AArr.push(A);
        rateArr.push(k * A * B);

        // Ορισμός της συνάρτησης παραγώγου
        const f = (A_val, B_val) => -k * A_val * B_val;
        const g = (A_val, B_val) => k * A_val * B_val;

        // RK4 υπολογισμοί για A και B
        const k1_A = dt * f(A, B);
        const k1_B = dt * g(A, B);

        const k2_A = dt * f(A + k1_A/2, B + k1_B/2);
        const k2_B = dt * g(A + k1_A/2, B + k1_B/2);

        const k3_A = dt * f(A + k2_A/2, B + k2_B/2);
        const k3_B = dt * g(A + k2_A/2, B + k2_B/2);

        const k4_A = dt * f(A + k3_A, B + k3_B);
        const k4_B = dt * g(A + k3_A, B + k3_B);

        A += (k1_A + 2*k2_A + 2*k3_A + k4_A)/6;
        B += (k1_B + 2*k2_B + 2*k3_B + k4_B)/6;

        // Εξασφάλιση μη αρνητικών τιμών
        A = Math.max(A, 0);
      }
      
      return { t: tArr, A: AArr, rate: rateArr };
    }

    // Συνάρτηση ενημέρωσης διαγράμματος
    function updatePlot() {
      // Λήψη και έλεγχος τιμών
      const A0 = parseFloat(document.getElementById('A0').value) || defaults.A0;
      const k = parseFloat(document.getElementById('k').value) || defaults.k;
      const C0_red = parseFloat(document.getElementById('C0_red').value) || defaults.C0_red;
      const C0_green = parseFloat(document.getElementById('C0_green').value) || defaults.C0_green;
      const tMax = parseFloat(document.getElementById('tMax').value) || defaults.tMax;
      const dt = parseFloat(document.getElementById('dt').value) || defaults.dt;
      const C0_auto = 1e-9;  // Ελάχιστη τιμή για την αυτοκατάλυση

      // Εκτέλεση προσομοιώσεων με τη μέθοδο RK4
      const auto = simulateRK4(A0, C0_auto, k, tMax, dt);
      const red  = simulateRK4(A0, C0_red, k, tMax, dt);
      const green = simulateRK4(A0, C0_green, k, tMax, dt);

      // Κανονικοποίηση των ταχυτήτων για το y2
      function findMax(arr) {
        let max = -Infinity;
        for (let val of arr) {
          if (val > max) max = val;
        }
        return max;
      }
      const maxRate = Math.max(findMax(auto.rate), findMax(red.rate), findMax(green.rate));
      const normalize = arr => maxRate > 0 ? arr.map(x => x/maxRate) : arr;

      const traces = [
        { x: auto.t, y: auto.A, name: 'Αυτοκατάλυση', line: { color: 'blue' } },
        { x: auto.t, y: normalize(auto.rate), name: 'Ταχύτητα Αυτοκατάλυσης', yaxis: 'y2', line: { color: 'blue', dash: 'dot' } },
        { x: red.t, y: red.A, name: `Κατάλυση (C₀=${C0_red} M)`, line: { color: 'red' } },
        { x: red.t, y: normalize(red.rate), name: 'Ταχύτητα Κόκκινη', yaxis: 'y2', line: { color: 'red', dash: 'dot' } },
        { x: green.t, y: green.A, name: `Κατάλυση (C₀=${C0_green} M)`, line: { color: 'green' } },
        { x: green.t, y: normalize(green.rate), name: 'Ταχύτητα Πράσινη', yaxis: 'y2', line: { color: 'green', dash: 'dot' } }
      ];

      Plotly.react('plot', traces, {
        title: `Σύγκριση Προσομοιώσεων (t_max: ${tMax}s, dt: ${dt}s)`,
        xaxis: { title: 'Χρόνος (s)', range: [0, tMax] },
        yaxis: { title: '[MnO₄⁻] (M)', range: [0, A0] },
        yaxis2: {
          title: 'Κανονικοποιημένη Ταχύτητα',
          overlaying: 'y',
          side: 'right',
          range: [0, 1.1]
        },
        legend: { orientation: 'h', x: 0, y: -0.2 }
      });
    }

    // Αρχική φόρτωση
    updatePlot();
  </script>
</body>
</html>
